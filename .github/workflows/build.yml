name: Building on all platforms

on: [push, pull_request]


jobs:

  Build:

    strategy:
      matrix:
        GHC_VERSION: [8.4, 8.6]
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:

      - uses: actions/checkout@v3
        name: Checkout repository

      - name: Stack version
        shell: bash
        run: cp etc/hs-deps/stack-${{ matrix.GHC_VERSION }}.yaml stack.yaml

      - uses: actions/cache@v3
        name: Cache global stack (Linux & Mac)
        if: runner.os != 'Windows'
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml') }}
          restore-keys: ${{ runner.os }}-stack-global-

      - uses: actions/cache@v3
        name: Cache global stack (Windows)
        if: runner.os == 'Windows'
        with:
          path: |
            ~\AppData\Roaming\stack
            ~\AppData\Local\Programs\stack    
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml') }}
          restore-keys: ${{ runner.os }}-stack-global-

      - uses: actions/cache@v3
        name: Cache local stack (Linux & Mac)
        if: runner.os != 'Windows'
        with:
          path: .stack-work
          key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml') }}-${{ hashFiles('**/*.hs') }}
          restore-keys: ${{ runner.os }}-stack-work-

      - uses: actions/cache@v3
        name: Cache local stack (Windows)
        if: runner.os == 'Windows'
        with:
          path: .stack-work
          key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml') }}-${{ hashFiles('**/*.hs') }}
          restore-keys: ${{ runner.os }}-stack-work-

      - name: Install Conjure
        shell: bash
        run: BIN_DIR=${HOME}/.local/bin PATH=${HOME}/.local/bin:${PATH} GHC_VERSION=${{ matrix.GHC_VERSION }} BUILD_TESTS=true make

      - name: Install Minion
        shell: bash
        run: BIN_DIR=${HOME}/.local/bin PATH=${HOME}/.local/bin:${PATH} etc/build/install-minion.sh

      - name: Simple test
        uses: sergeysova/jq-action@v2
        with:
          cmd: |
            echo "find x : set of int(1..5) such that sum(x)=5" > test.essence
            conjure solve test.essence --number-of-solutions=all --solutions-in-one-file --output-format=json
            cat test.solutions.json
            diff <(echo '[{"x":[5]},{"x":[2,3]},{"x":[1,4]}]' | jq -c .) <(jq -c . test.solutions.json)
